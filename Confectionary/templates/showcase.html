{% extends 'main_page.html' %}
{% load static %}
{% block content %}
<div class="container mt-5">
    <h1>Онлайн-витрина</h1>
    <div class="row g-0 bg-body-first position-relative">
        <div class="col-md-3 mb-md-0 p-md-4">
            <div class="list-group">
                <a href="{% url 'Confectionary:showcase' %}"
                    class="list-group-item {% if not selected_type %}active list-group-item-danger{% endif %}">Все</a>
                {% for type in product_types %}
                <a href="{% url 'Confectionary:showcase' %}?type={{ type }}"
                    class="list-group-item {% if type == selected_type %}active list-group-item-danger{% endif %}">{{ type }}</a>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-9 p-4 ps-md-0">
            <div class="row">
                {% for product in products %}
                <div class="col-12 col-md-12 col-lg-6 col-xl-6 col-xxl-4 mb-4">
                    <div class="card mb-3 h-100 d-flex flex-column">
                        <img src="{{ product.image.url }}" class="card-img-top img-fluid" alt="{{ product.name }}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ product.name }}</h5>
                            <p class="card-text">{{ product.short_description }}</p>
                            <div> 
                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#productModal{{ product.id }}">Подробнее</button>
                            </div>
                            <div class="mt-auto d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <form action="{% url 'Confectionary:trolley_add' product.id %}" method="post" class="d-flex align-items-center">
                                        {% csrf_token %}
                                        <div class="input-group input-group-sm me-2" style="width: 100px;">
                                             <input type="number"
                                                   name="quantity"
                                                   class="form-control text-center quantity-input"
                                                   value="1"
                                                   min="1"
                                                   max="{{ product.count_in_stock }}"
                                                   aria-label="Количество {{ product.name }}"
                                                   required>
                                        </div>
                                        <button type="submit" class="btn btn-sm add-to-cart-btn" style="background-color: #721c24; color: white;">В корзину</button> {# Текст изменен #}
                                    </form>
                                </div>
                            </div> 
                        </div>
                    </div>
                </div>

                <div class="modal fade" 
                  id="productModal{{ product.id }}" 
                  tabindex="-1" 
                  aria-labelledby="productModalLabel{{ product.id }}" 
                  aria-hidden="true" 
                  data-bs-backdrop="static"
                  data-bs-keyboard="false">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="productModalLabel{{ product.id }}">{{ product.name }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>{{ product.description }}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p>Продукты не найдены.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        function updateQuantityButtons(inputField) {
            const inputGroup = inputField.closest('.input-group');
            if (!inputGroup) return;
    
            const minusButton = inputGroup.querySelector('.btn-minus');
            const plusButton = inputGroup.querySelector('.btn-plus');
            const maxQuantity = parseInt(inputField.dataset.max || inputField.max, 10);
            const currentValue = parseInt(inputField.value, 10);
    
            if (minusButton) {
                minusButton.disabled = (currentValue <= 1);
            }
            if (plusButton) {
                 plusButton.disabled = (currentValue >= maxQuantity || maxQuantity <= 1);
            }
             if (minusButton && maxQuantity <= 1){
                  minusButton.disabled = true;
             }
        }
    
        document.querySelectorAll('.quantity-input').forEach(inputField => {
            updateQuantityButtons(inputField);
        });
    
        document.body.addEventListener('click', function(event) {
            const target = event.target;
            let inputField;
            let maxQuantity;
            let currentValue;
            let newValue;
    
            const inputGroup = target.closest('.input-group');
            if (!inputGroup) return;
    
            inputField = inputGroup.querySelector('.quantity-input');
            if (!inputField) return; 
    
            maxQuantity = parseInt(inputField.dataset.max || inputField.max, 10);
            currentValue = parseInt(inputField.value, 10);
    
            if (target.classList.contains('btn-plus')) {
                if (currentValue < maxQuantity) {
                    newValue = currentValue + 1;
                    inputField.value = newValue;
                     inputField.dispatchEvent(new Event('input', { bubbles: true }));
                }
            } else if (target.classList.contains('btn-minus')) {
                if (currentValue > 1) {
                    newValue = currentValue - 1;
                    inputField.value = newValue;
                     inputField.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
    
            updateQuantityButtons(inputField);
        });
    
        document.body.addEventListener('input', function(event) {
            if (event.target.classList.contains('quantity-input')) {
                const inputField = event.target;
                const maxQuantity = parseInt(inputField.dataset.max || inputField.max, 10);
                let currentValue = parseInt(inputField.value, 10);
    
                if (isNaN(currentValue) || currentValue < 1) {
                     inputField.value = 1;
                }
                else if (currentValue > maxQuantity) {
                     inputField.value = maxQuantity;
                }
    
                 updateQuantityButtons(inputField);
            }
        });
    
         document.body.addEventListener('keydown', function(event) {
            if (event.target.classList.contains('quantity-input') && event.key === 'Enter') {
                event.preventDefault(); 
                event.target.blur(); 
            }
        });
    });
</script>
{% endblock %}